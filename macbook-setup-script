#!/usr/bin/env bash

set -e  # Exit on error
set -u  # Exit on undefined variable

echo "Starting macOS setup for 2025..."

# Check for Homebrew, install if missing
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ $(uname -m) == "arm64" ]]; then
        echo "Configuring Homebrew for Apple Silicon..."
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

echo "Updating Homebrew..."
brew update

# Install packages
PACKAGES=(
    git
    bat
    macvim
    mysql
    fzf
    universal-ctags
    readline
    python3
    pipx
    gh
    jq
    wget
    ripgrep
)

echo "Installing packages..."
brew install "${PACKAGES[@]}"

echo "Installing Python tools via pipx..."
pipx ensurepath
pipx install virtualenv
pipx install virtualenvwrapper

# Install cask applications
CASKS=(
    iterm2
    adobe-acrobat-reader
    spotify
    visual-studio-code
    1password
    google-drive
    nextcloud
    vlc
    raspberry-pi-imager
    brave-browser
)

echo "Installing cask applications..."
for app in "${CASKS[@]}"; do
    if brew list --cask "$app" &>/dev/null; then
        echo "‚è≠Ô∏è  $app already installed, skipping..."
    else
        echo "üì¶ Installing $app..."
        brew install --cask "$app" || echo "‚ö†Ô∏è  Failed to install $app, continuing..."
    fi
done

echo "Cleaning up..."
brew cleanup

echo ""
echo "‚úÖ Machine setup completed successfully!"
echo ""
echo "üìù Post-setup notes:"
echo "  - Run 'source ~/.zprofile' or restart your terminal to apply PATH changes"
echo "  - Configure virtualenvwrapper by adding to your shell config:"
echo "    export WORKON_HOME=\$HOME/.virtualenvs"
echo "    export VIRTUALENVWRAPPER_PYTHON=$(which python3)"
echo "    source $(pipx environment --value PIPX_BIN_DIR)/virtualenvwrapper.sh"
echo "  - Configure fzf keybindings: \$(brew --prefix)/opt/fzf/install"
echo "  - GitHub CLI: Run 'gh auth login' to authenticate"
echo ""
echo "üÜï New tools added:"
echo "  - universal-ctags: Modern replacement for ctags"
echo "  - gh: GitHub CLI for repository management"
echo "  - jq: JSON processor for command line"
echo "  - wget: Network downloader"
echo "  - ripgrep: Faster grep alternative (use 'rg' command)"
